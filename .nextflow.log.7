Sep-23 15:02:52.122 [main] DEBUG nextflow.cli.Launcher - $> nextflow run main.nf --sample BIDI_mpox_case2_hybrid_APHLproject_work_20250923_103207_DQ011155.1 --nextclade_json nextclade.json --gff sequence.gff3
Sep-23 15:02:52.207 [main] DEBUG nextflow.cli.CmdRun - N E X T F L O W  ~  version 25.04.7
Sep-23 15:02:52.230 [main] DEBUG nextflow.plugin.PluginsFacade - Setting up plugin manager > mode=prod; embedded=false; plugins-dir=/home/cdcadmin/.nextflow/plugins; core-plugins: nf-amazon@2.15.0-patch1,nf-azure@1.16.0-patch1,nf-cloudcache@0.4.3,nf-codecommit@0.2.3,nf-console@1.2.1,nf-google@1.21.1,nf-k8s@1.0.0,nf-tower@1.11.4-patch1,nf-wave@1.12.1
Sep-23 15:02:52.251 [main] INFO  o.pf4j.DefaultPluginStatusProvider - Enabled plugins: []
Sep-23 15:02:52.252 [main] INFO  o.pf4j.DefaultPluginStatusProvider - Disabled plugins: []
Sep-23 15:02:52.267 [main] INFO  org.pf4j.DefaultPluginManager - PF4J version 3.12.0 in 'deployment' mode
Sep-23 15:02:52.279 [main] INFO  org.pf4j.AbstractPluginManager - No plugins
Sep-23 15:02:52.299 [main] DEBUG nextflow.config.ConfigBuilder - Found config local: /home/cdcadmin/Downloads/frameshift-check/nextflow.config
Sep-23 15:02:52.301 [main] DEBUG nextflow.config.ConfigBuilder - Parsing config file: /home/cdcadmin/Downloads/frameshift-check/nextflow.config
Sep-23 15:02:52.328 [main] DEBUG n.secret.LocalSecretsProvider - Secrets store: /home/cdcadmin/.nextflow/secrets/store.json
Sep-23 15:02:52.331 [main] DEBUG nextflow.secret.SecretsLoader - Discovered secrets providers: [nextflow.secret.LocalSecretsProvider@5a101b1c] - activable => nextflow.secret.LocalSecretsProvider@5a101b1c
Sep-23 15:02:52.343 [main] DEBUG nextflow.config.ConfigBuilder - Applying config profile: `standard`
Sep-23 15:02:52.845 [main] DEBUG nextflow.cli.CmdRun - Applied DSL=2 from script declaration
Sep-23 15:02:52.863 [main] DEBUG nextflow.cli.CmdRun - Launching `main.nf` [furious_nobel] DSL2 - revision: d4cecad8fa
Sep-23 15:02:52.865 [main] DEBUG nextflow.plugin.PluginsFacade - Plugins default=[]
Sep-23 15:02:52.865 [main] DEBUG nextflow.plugin.PluginsFacade - Plugins resolved requirement=[]
Sep-23 15:02:52.914 [main] DEBUG nextflow.Session - Session UUID: 884fb58a-9e4a-4934-85d1-a7bcc5b45746
Sep-23 15:02:52.915 [main] DEBUG nextflow.Session - Run name: furious_nobel
Sep-23 15:02:52.915 [main] DEBUG nextflow.Session - Executor pool size: 128
Sep-23 15:02:52.923 [main] DEBUG nextflow.file.FilePorter - File porter settings maxRetries=3; maxTransfers=50; pollTimeout=null
Sep-23 15:02:52.928 [main] DEBUG nextflow.util.ThreadPoolBuilder - Creating thread pool 'FileTransfer' minSize=10; maxSize=384; workQueue=LinkedBlockingQueue[-1]; allowCoreThreadTimeout=false
Sep-23 15:02:52.947 [main] DEBUG nextflow.cli.CmdRun - 
  Version: 25.04.7 build 5955
  Created: 08-09-2025 13:29 UTC (20:29 ICST)
  System: Linux 5.15.0-1086-nvidia
  Runtime: Groovy 4.0.26 on OpenJDK 64-Bit Server VM 17.0.10+7
  Encoding: UTF-8 (UTF-8)
  Process: 3966640@cdcadmin [127.0.1.1]
  CPUs: 128 - Mem: 503.7 GB (163.5 GB) - Swap: 8 GB (7.9 GB)
Sep-23 15:02:52.972 [main] DEBUG nextflow.Session - Work-dir: /home/cdcadmin/Downloads/frameshift-check/work [ext2/ext3]
Sep-23 15:02:52.973 [main] DEBUG nextflow.Session - Script base path does not exist or is not a directory: /home/cdcadmin/Downloads/frameshift-check/bin
Sep-23 15:02:52.982 [main] DEBUG nextflow.executor.ExecutorFactory - Extension executors providers=[]
Sep-23 15:02:52.991 [main] DEBUG nextflow.Session - Observer factory: DefaultObserverFactory
Sep-23 15:02:52.995 [main] DEBUG nextflow.Session - Observer factory (v2): LinObserverFactory
Sep-23 15:02:53.024 [main] DEBUG nextflow.cache.CacheFactory - Using Nextflow cache factory: nextflow.cache.DefaultCacheFactory
Sep-23 15:02:53.035 [main] DEBUG nextflow.util.CustomThreadPool - Creating default thread pool > poolSize: 129; maxThreads: 1000
Sep-23 15:02:53.090 [main] DEBUG nextflow.Session - Session start
Sep-23 15:02:53.663 [main] DEBUG nextflow.script.ScriptRunner - > Launching execution
Sep-23 15:02:53.758 [main] DEBUG nextflow.script.ProcessConfig - Config settings `withName:EnsureDeps` matches process EnsureDeps
Sep-23 15:02:53.763 [main] DEBUG nextflow.executor.ExecutorFactory - << taskConfig executor: local
Sep-23 15:02:53.764 [main] DEBUG nextflow.executor.ExecutorFactory - >> processorType: 'local'
Sep-23 15:02:53.769 [main] DEBUG nextflow.executor.Executor - [warm up] executor > local
Sep-23 15:02:53.774 [main] DEBUG n.processor.LocalPollingMonitor - Creating local task monitor for executor 'local' > cpus=128; memory=503.7 GB; capacity=128; pollInterval=100ms; dumpInterval=5m
Sep-23 15:02:53.776 [main] DEBUG n.processor.TaskPollingMonitor - >>> barrier register (monitor: local)
Sep-23 15:02:53.801 [main] DEBUG nextflow.processor.TaskProcessor - Creating process 'EnsureDeps': maxForks=0; fair=false; array=0
Sep-23 15:02:53.854 [main] DEBUG nextflow.script.ProcessConfig - Config settings `withName:FilterNextcladeForSample` matches process FilterNextcladeForSample
Sep-23 15:02:53.859 [main] DEBUG nextflow.executor.ExecutorFactory - << taskConfig executor: local
Sep-23 15:02:53.859 [main] DEBUG nextflow.executor.ExecutorFactory - >> processorType: 'local'
Sep-23 15:02:53.861 [main] DEBUG nextflow.processor.TaskProcessor - Creating process 'FilterNextcladeForSample': maxForks=0; fair=false; array=0
Sep-23 15:02:53.872 [main] DEBUG nextflow.script.ProcessConfig - Config settings `withName:MakeCdsBed` matches process MakeCdsBed
Sep-23 15:02:53.873 [main] DEBUG nextflow.executor.ExecutorFactory - << taskConfig executor: local
Sep-23 15:02:53.873 [main] DEBUG nextflow.executor.ExecutorFactory - >> processorType: 'local'
Sep-23 15:02:53.875 [main] DEBUG nextflow.processor.TaskProcessor - Creating process 'MakeCdsBed': maxForks=0; fair=false; array=0
Sep-23 15:02:53.902 [main] DEBUG nextflow.script.ProcessConfig - Config settings `withName:IndelsToBeds` matches process IndelsToBeds
Sep-23 15:02:53.903 [main] DEBUG nextflow.executor.ExecutorFactory - << taskConfig executor: local
Sep-23 15:02:53.904 [main] DEBUG nextflow.executor.ExecutorFactory - >> processorType: 'local'
Sep-23 15:02:53.905 [main] DEBUG nextflow.processor.TaskProcessor - Creating process 'IndelsToBeds': maxForks=0; fair=false; array=0
Sep-23 15:02:53.914 [main] DEBUG nextflow.script.ProcessConfig - Config settings `withName:VerifyFrameshifts` matches process VerifyFrameshifts
Sep-23 15:02:53.915 [main] DEBUG nextflow.executor.ExecutorFactory - << taskConfig executor: local
Sep-23 15:02:53.916 [main] DEBUG nextflow.executor.ExecutorFactory - >> processorType: 'local'
Sep-23 15:02:53.916 [main] DEBUG nextflow.processor.TaskProcessor - Creating process 'VerifyFrameshifts': maxForks=0; fair=false; array=0
Sep-23 15:02:53.921 [main] DEBUG nextflow.Session - Workflow process names [dsl2]: IndelsToBeds, MapIllumina, FilterNextcladeForSample, EnsureDeps, MapONT, VerifyFrameshifts, CallONT, MakeCdsBed, CallIllumina
Sep-23 15:02:53.927 [main] DEBUG nextflow.Session - Igniting dataflow network (14)
Sep-23 15:02:53.932 [main] DEBUG nextflow.processor.TaskProcessor - Starting process > EnsureDeps
Sep-23 15:02:53.933 [main] DEBUG nextflow.processor.TaskProcessor - Starting process > FilterNextcladeForSample
Sep-23 15:02:53.934 [main] DEBUG nextflow.processor.TaskProcessor - Starting process > MakeCdsBed
Sep-23 15:02:53.934 [main] DEBUG nextflow.processor.TaskProcessor - Starting process > IndelsToBeds
Sep-23 15:02:53.935 [main] DEBUG nextflow.processor.TaskProcessor - Starting process > VerifyFrameshifts
Sep-23 15:02:53.935 [main] DEBUG nextflow.script.ScriptRunner - Parsed script files:
  Script_67b9ce2df5062b5f: /home/cdcadmin/Downloads/frameshift-check/main.nf
Sep-23 15:02:53.935 [main] DEBUG nextflow.script.ScriptRunner - > Awaiting termination 
Sep-23 15:02:53.935 [main] DEBUG nextflow.Session - Session await
Sep-23 15:02:54.001 [Actor Thread 21] DEBUG nextflow.util.HashBuilder - Unable to get file attributes file: /home/cdcadmin/Downloads/frameshift-check/NO_FILE -- Cause: java.nio.file.NoSuchFileException: /home/cdcadmin/Downloads/frameshift-check/NO_FILE
Sep-23 15:02:54.002 [Actor Thread 21] DEBUG nextflow.util.HashBuilder - Unable to get file attributes file: /home/cdcadmin/Downloads/frameshift-check/NO_FILE -- Cause: java.nio.file.NoSuchFileException: /home/cdcadmin/Downloads/frameshift-check/NO_FILE
Sep-23 15:02:54.058 [Task submitter] DEBUG n.executor.local.LocalTaskHandler - Launch cmd line: /bin/bash -ue .command.run
Sep-23 15:02:54.060 [Task submitter] INFO  nextflow.Session - [6a/bd749c] Submitted process > IndelsToBeds (indels_to_bed)
Sep-23 15:02:54.068 [Task submitter] DEBUG n.executor.local.LocalTaskHandler - Launch cmd line: /bin/bash -ue .command.run
Sep-23 15:02:54.069 [Task submitter] INFO  nextflow.Session - [32/8d97ec] Submitted process > EnsureDeps (check_deps)
Sep-23 15:02:54.073 [Task submitter] DEBUG n.executor.local.LocalTaskHandler - Launch cmd line: /bin/bash -ue .command.run
Sep-23 15:02:54.074 [Task submitter] INFO  nextflow.Session - [78/aba386] Submitted process > MakeCdsBed (gff_to_bed)
Sep-23 15:02:54.079 [Task submitter] DEBUG n.executor.local.LocalTaskHandler - Launch cmd line: /bin/bash -ue .command.run
Sep-23 15:02:54.080 [Task submitter] INFO  nextflow.Session - [23/967697] Submitted process > FilterNextcladeForSample (BIDI_mpox_case2_hybrid_APHLproject_work_20250923_103207_DQ011155.1)
Sep-23 15:02:54.088 [Task monitor] DEBUG n.processor.TaskPollingMonitor - Task completed > TaskHandler[id: 2; name: IndelsToBeds (indels_to_bed); status: COMPLETED; exit: 0; error: -; workDir: /home/cdcadmin/Downloads/frameshift-check/work/6a/bd749cfe631e971be617621d538097]
Sep-23 15:02:54.089 [Task monitor] DEBUG nextflow.util.ThreadPoolBuilder - Creating thread pool 'TaskFinalizer' minSize=10; maxSize=384; workQueue=LinkedBlockingQueue[-1]; allowCoreThreadTimeout=false
Sep-23 15:02:54.092 [Task monitor] DEBUG n.processor.TaskPollingMonitor - Task completed > TaskHandler[id: 4; name: EnsureDeps (check_deps); status: COMPLETED; exit: 0; error: -; workDir: /home/cdcadmin/Downloads/frameshift-check/work/32/8d97ec03db666614ebb14967b8f6b8]
Sep-23 15:02:54.093 [Task monitor] DEBUG n.processor.TaskPollingMonitor - Task completed > TaskHandler[id: 1; name: MakeCdsBed (gff_to_bed); status: COMPLETED; exit: 0; error: -; workDir: /home/cdcadmin/Downloads/frameshift-check/work/78/aba386146d2a04a79800e9e73c3157]
Sep-23 15:02:54.437 [Task monitor] DEBUG n.processor.TaskPollingMonitor - Task completed > TaskHandler[id: 3; name: FilterNextcladeForSample (BIDI_mpox_case2_hybrid_APHLproject_work_20250923_103207_DQ011155.1); status: COMPLETED; exit: 0; error: -; workDir: /home/cdcadmin/Downloads/frameshift-check/work/23/9676971c37514506c067ec6bb92f72]
Sep-23 15:02:54.456 [Task submitter] DEBUG n.executor.local.LocalTaskHandler - Launch cmd line: /bin/bash -ue .command.run
Sep-23 15:02:54.456 [Task submitter] INFO  nextflow.Session - [ac/3477ab] Submitted process > VerifyFrameshifts (verify_and_harmonize)
Sep-23 15:02:54.494 [Task monitor] DEBUG n.processor.TaskPollingMonitor - Task completed > TaskHandler[id: 5; name: VerifyFrameshifts (verify_and_harmonize); status: COMPLETED; exit: 1; error: -; workDir: /home/cdcadmin/Downloads/frameshift-check/work/ac/3477ab142df0766739024e04c62fdb]
Sep-23 15:02:54.499 [TaskFinalizer-5] DEBUG nextflow.processor.TaskProcessor - Handling unexpected condition for
  task: name=VerifyFrameshifts (verify_and_harmonize); work-dir=/home/cdcadmin/Downloads/frameshift-check/work/ac/3477ab142df0766739024e04c62fdb
  error [nextflow.exception.ProcessFailedException]: Process `VerifyFrameshifts (verify_and_harmonize)` terminated with an error exit status (1)
Sep-23 15:02:54.513 [TaskFinalizer-5] ERROR nextflow.processor.TaskProcessor - Error executing process > 'VerifyFrameshifts (verify_and_harmonize)'

Caused by:
  Process `VerifyFrameshifts (verify_and_harmonize)` terminated with an error exit status (1)


Command executed:

  set -euo pipefail
  export ALIAS_MAP="${alias_map_path ?: ''}"
  
        # Intersections
        bedtools intersect -wa -wb -a ${ilmn} -b ${cds} > ilmn.cds.tsv || true
        bedtools intersect -wa -wb -a ${ont}  -b ${cds} > ont.cds.tsv  || true
  
        python3 - <<'PY'
  import csv, json, os, re
  
  # Load optional alias map (TSV: ncbi_name  nextclade_name)
  alias_map = {}
  alias_path = os.environ.get("ALIAS_MAP")
  if alias_path and os.path.exists(alias_path):
      with open(alias_path) as f:
          for line in f:
              if not line.strip() or line.startswith("#"): continue
              a=line.rstrip().split('	')
              if len(a)>=2:
                  alias_map[a[0].strip()] = a[1].strip()
  
  def parse_attrs(attr_str):
      d={}
      for kv in attr_str.split(';'):
          if not kv: continue
          if '=' in kv:
              k,v = kv.split('=',1)
              d[k.strip()] = v.strip()
      return d
  
  def harmonize_gene(attr_str):
      attrs = parse_attrs(attr_str)
      candidates = [attrs.get('gene'), attrs.get('Name'), attrs.get('locus_tag'), attrs.get('protein_id'), attrs.get('product')]
      for c in candidates:
          if c:
              g = re.sub(r'^"|"$','',c).strip()
              return alias_map.get(g, g)
      return ""
  
  def load_intersections(path):
      out=[]
      if not os.path.exists(path) or os.path.getsize(path)==0: return out
      with open(path) as f:
          for line in f:
              a=line.rstrip().split('	')
              attr=a[15] if len(a)>15 else ""
              strand=a[17] if len(a)>17 else ""
              gene = harmonize_gene(attr)
              out.append({
                "chrom":a[0], "pos":a[2], "ref":a[4], "alt":a[5],
                "len":a[6], "frameshift":a[7], "platform":a[3],
                "dp":a[8], "qual":a[9], "af":a[10], "type":a[11],
                "gene":gene, "strand":strand
              })
      return out
  
  ilmn=load_intersections("ilmn.cds.tsv")
  ont =load_intersections("ont.cds.tsv")
  
  from collections import defaultdict
  by=defaultdict(dict)
  for r in ilmn+ont:
      k=(r["chrom"], r["pos"], r["ref"], r["alt"], r["gene"])
      by[k].setdefault("strand", r["strand"])
      by[k]["frameshift"]=r["frameshift"]
      by[k][r["platform"]+"_dp"]=r["dp"]; by[k][r["platform"]+"_af"]=r["af"]
      by[k]["len"]=r["len"]
  
  # Load Nextclade frameshifts & stop codons
  nc=json.load(open("nextclade_sample_summary.json"))
  # Handle frameShifts - it might be a dict with frameShifts key, or directly a list
  fs_data = nc.get("frameShifts", {})
  if isinstance(fs_data, dict):
      nc_fs = [(f.get("cdsName","?"), f.get("codon",{}).get("begin"), f.get("codon",{}).get("end")) for f in fs_data.get("frameShifts", [])]
  else:
      nc_fs = [(f.get("cdsName","?"), f.get("codon",{}).get("begin"), f.get("codon",{}).get("end")) for f in (fs_data or [])]
  
  # Handle stopCodons - similar logic
  sc_data = nc.get("stopCodons", {})
  if isinstance(sc_data, dict):
      nc_stops = [(e.get("cdsName","?"), e.get("codon")) for e in sc_data.get("stopCodons", [])]
  else:
      nc_stops = [(e.get("cdsName","?"), e.get("codon")) for e in (sc_data or [])]
  nc_aa = nc.get("aaSubstitutions",[]) or []
  nc_aa_stops = [(x.get("cdsName","?"), x.get("pos")) for x in nc_aa if x.get("qryAa")=="*"]
  
  # Export Nextclade-reported features to help refine alias map if needed
  harm=[]
  seen=set()
  for cds,beg,end in nc_fs:
      k=(cds,"frameshift",f"{beg}-{end}")
      if k not in seen:
          harm.append({"nextclade_name":cds, "kind":"frameshift", "detail":f"codons {beg}-{end}"}); seen.add(k)
  for cds,co in nc_stops:
      k=(cds,"stop",str(co))
      if k not in seen:
          harm.append({"nextclade_name":cds, "kind":"stop", "detail":f"codon {co}"}); seen.add(k)
  for cds,co in nc_aa_stops:
      k=(cds,"stopSubst",str(co))
      if k not in seen:
          harm.append({"nextclade_name":cds, "kind":"stopSubst", "detail":f"codon {co}"}); seen.add(k)
  
  with open("harmonized_gene_map.tsv","w",newline="") as f:
      w=csv.DictWriter(f,fieldnames=["nextclade_name","kind","detail"])
      w.writeheader()
      w.writerows(harm)
  
  with open("frameshift_report.csv","w",newline="") as f:
      w=csv.writer(f)
      w.writerow(["chrom","pos","gene","strand","ref","alt","indel_len","frameshift",
                  "ilmn_dp","ilmn_af","ont_dp","ont_af","matches_nextclade_gene"])
      for (chrom,pos,ref,alt,gene),v in sorted(by.items()):
          match = "yes" if any(gene==cds or gene==cds.split('|')[0] for (cds,_,_) in nc_fs) else "no"
          w.writerow([chrom,pos,gene,v.get("strand",""),ref,alt,v.get("len",""),
                      v.get("frameshift",""),v.get("ILMN_dp",""),v.get("ILMN_af",""),
                      v.get("ONT_dp",""),v.get("ONT_af",""), match])
  PY

Command exit status:
  1

Command output:
  (empty)

Command error:
  .command.sh: line 3: ${alias_map_path ?: ''}: bad substitution

Work dir:
  /home/cdcadmin/Downloads/frameshift-check/work/ac/3477ab142df0766739024e04c62fdb

Tip: you can try to figure out what's wrong by changing to the process work dir and showing the script file named `.command.sh`
Sep-23 15:02:54.516 [main] DEBUG nextflow.Session - Session await > all processes finished
Sep-23 15:02:54.516 [TaskFinalizer-5] DEBUG nextflow.Session - Session aborted -- Cause: Process `VerifyFrameshifts (verify_and_harmonize)` terminated with an error exit status (1)
Sep-23 15:02:54.530 [main] DEBUG nextflow.Session - Session await > all barriers passed
Sep-23 15:02:54.531 [Task monitor] DEBUG n.processor.TaskPollingMonitor - <<< barrier arrives (monitor: local) - terminating tasks monitor poll loop
Sep-23 15:02:54.537 [main] DEBUG n.trace.WorkflowStatsObserver - Workflow completed > WorkflowStats[succeededCount=4; failedCount=1; ignoredCount=0; cachedCount=0; pendingCount=0; submittedCount=0; runningCount=0; retriesCount=0; abortedCount=0; succeedDuration=350ms; failedDuration=19ms; cachedDuration=0ms;loadCpus=0; loadMemory=0; peakRunning=4; peakCpus=4; peakMemory=0; ]
Sep-23 15:02:54.726 [main] DEBUG nextflow.cache.CacheDB - Closing CacheDB done
Sep-23 15:02:54.738 [main] DEBUG nextflow.script.ScriptRunner - > Execution complete -- Goodbye
